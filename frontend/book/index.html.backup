<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Account Priority Queue - Northlight</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@700;800&display=swap" rel="stylesheet">
  <style>
/* ===========================
    NORTHLIGHT â€“ Design System
    =========================== */
:root{
  --gray-50:#f8fafc; --gray-100:#f1f5f9; --gray-200:#e2e8f0; --gray-300:#cbd5e1;
  --gray-400:#94a3b8; --gray-500:#64748b; --gray-700:#334155; --gray-900:#0f172a;
  --primary-50:#eff6ff; --primary-500:#3b82f6; --primary-600:#2563eb; --primary-700:#1d4ed8;
  --red-50:#fef2f2; --red-100:#fee2e2; --red-600:#dc2626; --red-700:#b91c1c; --red-800:#991b1b;
  --orange-50:#fff7ed; --orange-100:#ffedd5; --orange-600:#ea580c;
  --green-100:#dcfce7; --green-700:#15803d;
  --blue-100:#dbeafe; --blue-700:#1d4ed8;

  --text-xs:12px; --text-sm:14px; --text-base:16px; --text-lg:18px; --text-xl:20px; --text-2xl:24px; --text-3xl:30px;
  --space-1:4px; --space-2:8px; --space-3:12px; --space-4:16px; --space-5:20px; --space-6:24px; --space-8:32px; --space-12:48px;
  --radius-sm:6px; --radius-md:8px; --radius-lg:12px; --radius-xl:16px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  line-height:1.5; color:var(--gray-900); background:var(--gray-50);
  margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
}
main {max-width:1400px; margin:0 auto; padding:var(--space-8);}
h1,h2,h3{margin:0; font-weight:700}
p{margin:0 0 var(--space-4)}
.subtext{color:var(--gray-500); font-size:var(--text-sm)}

header.header{
  padding:16px 40px; border-bottom:1px solid var(--gray-200); background:rgba(255,255,255,.9);
  backdrop-filter:blur(10px); box-shadow:0 2px 8px rgba(0,0,0,.08); position:sticky; top:0; z-index:10;
}
.header-content{display:flex; justify-content:space-between; align-items:center; max-width:1400px; margin:0 auto;}
.brand-section{display:flex; flex-direction:column;}
.brand-name{display:flex; align-items:baseline; margin-bottom:2px}
.company-name{font-family:'Montserrat',sans-serif; font-weight:800; font-size:28px; color:#2d3748; letter-spacing:1px}
.beta-label{font-weight:500; font-size:12px; color:#f6ad55; margin-left:6px; vertical-align:super}
.tagline{font-weight:400; font-size:14px; color:#718096; margin-top:0}
.data-freshness{font-size:12px; color:var(--gray-500); margin-top:4px; cursor:help}
.freshness-label{font-weight:500}
.freshness-date{font-weight:600; color:var(--gray-700)}
.nav-tabs{display:flex; gap:var(--space-2)}
.nav-tab{
  padding:var(--space-2) var(--space-4); border-radius:var(--radius-md); font-size:var(--text-sm); font-weight:600;
  text-decoration:none; color:var(--gray-700); border:1px solid var(--gray-200); background:#fff; cursor:pointer;
}
.nav-tab:hover{background:var(--gray-50)}
.nav-tab.active{background:var(--primary-500); color:#fff; border-color:var(--primary-500)}

.summary-grid{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:var(--space-6); margin:var(--space-6) 0;
}
.summary-card{
  background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg);
  padding:var(--space-5); text-align:center;
}
.summary-card.critical{border-left:4px solid var(--red-600)}
.summary-card.high{border-left:4px solid var(--orange-600)}
.summary-number{font-size:var(--text-3xl); font-weight:700; margin-bottom:var(--space-2)}
.summary-number.critical{color:var(--red-700)}
.summary-number.high{color:var(--orange-600)}
.summary-label{font-size:var(--text-sm); color:var(--gray-500); font-weight:500}

.filter-bar{
  background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg);
  padding:var(--space-4); margin:var(--space-6) 0; display:flex; gap:var(--space-4); align-items:center; flex-wrap:wrap;
}
.filter-group{display:flex; flex-direction:column; gap:var(--space-2)}
.filter-label{font-size:var(--text-xs); color:var(--gray-500); font-weight:700; text-transform:uppercase; letter-spacing:.5px;}
.filter-select{
  border:1px solid var(--gray-300); border-radius:var(--radius-md);
  padding:var(--space-2) var(--space-3); font-size:var(--text-sm); background:#fff; min-width:180px;
}

/* ===========================
    Card List Layout
    =========================== */
.content-card{
  background:#fff; border:1px solid var(--gray-200); border-radius:var(--radius-lg);
  padding:var(--space-6); margin:var(--space-6) 0;
}
.cards-list{display:flex; flex-direction:column; gap:12px;}
.load-more{
  display:none; margin:16px auto 0; padding:10px 16px; font-weight:700;
  border:1px solid var(--gray-300); background:#fff; border-radius:8px; cursor:pointer;
}
.load-more:hover{background:var(--gray-100);}

/* ===========================
    Priority Card
    =========================== */
.priority-card{
  background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.08); overflow:hidden;
  position:relative; transition:all .2s ease; border:1px solid var(--gray-200);
}
.priority-card::before{content:""; position:absolute; left:0; top:0; bottom:0; width:4px;}
.priority-card.critical::before{background:var(--red-600)}
.priority-card.warning::before{background:var(--orange-600)}
.priority-card.monitoring::before{background:var(--gray-400)}
.priority-card.safe::before{background:var(--green-700)} /* New safe status */
.priority-card:hover{transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.12);}

.card-header{padding:20px 24px; cursor:pointer; position:relative;}
.card-header:hover{background:linear-gradient(to right,#fafafa,transparent)}
.card-main-row{display:flex; align-items:flex-start; gap:24px;}

.churn-display{display:flex; flex-direction:column; align-items:center; min-width:85px;}
.churn-percentage{font-size:36px; font-weight:800; line-height:1;}
.churn-percentage.critical{color:var(--red-700)}
.churn-percentage.warning{color:var(--orange-600)}
.churn-percentage.monitoring{color:var(--gray-700)}
.churn-percentage.safe{color:var(--green-700); font-size:44px;} /* New safe status */
.churn-label{font-size:11px; color:var(--gray-500); font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-top:4px;}

.account-section{flex:1; min-width:0;}
.account-name{font-size:16px; font-weight:700; color:#1f2937; margin-bottom:2px;}
.campaign-name-sub{font-size:13px; font-weight:500; color:var(--gray-500); margin-bottom:4px;}
.primary-issue{font-size:14px; font-weight:600; margin-bottom:8px; color:var(--red-700);}
.primary-issue.warning{color:var(--orange-600)}
.primary-issue.neutral{color:var(--gray-500)}
.primary-issue.safe{color:var(--green-700)} /* New safe status */

.account-details{display:flex; gap:16px; font-size:12px; color:var(--gray-600); flex-wrap:wrap;}
.detail-item{display:flex; gap:4px;}
.detail-item strong{color:#111827}

.rar-section{text-align:right; min-width:160px;}
.rar-amount{font-size:28px; font-weight:800; color:#1f2937; line-height:1;}
.rar-label{font-size:11px; color:#6b7280; text-transform:uppercase; letter-spacing:.5px; margin-top:4px;}
.budget-context{font-size:13px; color:var(--gray-500); margin-top:4px;}

.status-line{display:flex; align-items:center; gap:12px; margin-top:12px; padding-top:12px; border-top:1px solid var(--gray-200);}
.status-badge{
  display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:6px; font-size:11px; font-weight:700;
}
.status-badge.urgent{background:var(--red-100); color:var(--red-800)}
.status-badge.warning{background:var(--orange-100); color:var(--orange-600)}
.status-badge.info{background:var(--blue-100); color:var(--blue-700)}
.status-badge.success{background:var(--green-100); color:var(--green-700)}
.time-indicator{margin-left:auto; font-size:11px; color:var(--gray-400);}

.expand-arrow{position:absolute; right:24px; top:50%; transform:translateY(-50%); color:var(--gray-400); font-size:20px; transition:transform .2s;}
.expand-arrow.expanded{transform:translateY(-50%) rotate(90deg);}

.card-expanded{display:none; background:#fafbfc; border-top:1px solid var(--gray-200);}
.card-expanded.show{display:block;}
.expanded-content{padding:24px;}

/* Sections */
.section-title{
  font-size:12px; font-weight:800; text-transform:uppercase; letter-spacing:.5px;
  color:var(--gray-500); margin-bottom:12px;
}

/* Risk Breakdown */
.risk-breakdown{background:#fff; border-radius:8px; padding:16px; margin-bottom:20px; box-shadow:0 1px 3px rgba(0,0,0,.05);}
.risk-factor{display:flex; align-items:center; margin-bottom:12px; gap:16px;}
.factor-label{width:140px; font-size:13px; color:#4b5563;}
.factor-bar{flex:1; height:24px; background:#e5e7eb; border-radius:4px; overflow:hidden;}
.factor-fill{height:100%; display:flex; align-items:center; justify-content:flex-end; padding-right:8px; color:white; font-size:11px; font-weight:700; transition:width .6s ease;}
.factor-fill.baseline{background:#6b7280;}
.factor-fill.risk{background:#ef4444;}
.factor-fill.protective{background:#10b981;}
.factor-context{min-width:140px; font-size:12px; color:#6b7280; text-align:right;}
.total-risk{padding-top:12px; margin-top:12px; border-top:2px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center; font-weight:800;}

/* Attribution composite bar (optional) */
.attrib-stack {
  position: relative; height:24px; background:#e5e7eb;
  border-radius:4px; overflow:hidden; margin:8px 0 4px 0;
}
.attrib-seg { position:absolute; top:0; bottom:0; display:flex; align-items:center; justify-content:flex-end; padding-right:8px; color:#fff; font-size:11px; font-weight:700; }
.attrib-seg .label { pointer-events:none; white-space:nowrap; }

/* Metrics */
.metrics-bar{
  background:#fff; border-radius:8px; padding:16px; margin-bottom:20px; display:flex; gap:32px; flex-wrap:wrap; box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.metric-item{display:flex; align-items:baseline; gap:8px;}
.metric-label{font-size:11px; color:#6b7280; font-weight:700; text-transform:uppercase;}
.metric-value{font-size:16px; font-weight:800; color:#1f2937;}
.metric-trend{font-size:14px; font-weight:800;}
.trend-up{color:var(--red-700)}
.trend-down{color:var(--green-700)}
.trend-neutral{color:var(--gray-500)}
.metric-context{font-size:12px; color:#6b7280}

/* Actions */
.priority-actions{background:#fff; border-radius:8px; padding:16px; box-shadow:0 1px 3px rgba(0,0,0,.05);}
.action-item{
  border:1px solid #e5e7eb; border-radius:8px; padding:12px 14px; margin-bottom:10px;
  display:flex; justify-content:space-between; align-items:center; transition:all .2s ease; cursor:pointer;
}
.action-item:last-child{margin-bottom:0;}
.action-item:hover{border-color:var(--primary-500); background:var(--primary-50); transform:translateX(2px);}
.action-content{flex:1;}
.action-title{font-size:14px; font-weight:700; color:#1f2937; margin-bottom:2px;}
.action-impact{font-size:12px; color:#059669; font-weight:700;}
.action-button{
  padding:8px 12px; background:var(--primary-500); color:#fff; border:0; border-radius:8px; font-size:12px; font-weight:800; cursor:pointer;
}
.action-button:hover{background:var(--primary-600)}

/* ===== Churn Risk Waterfall (refined) ===== */
.nl-waterfall { --h: 28px; --gap: 10px; position: relative; }
.nl-waterfall .wf-row { display:flex; align-items:center; gap:16px; margin:10px 0; }
.nl-waterfall .wf-label { flex:0 0 220px; color:#334155; font-weight:600; }
.nl-waterfall .wf-track-wrap { position:relative; flex:1; height:var(--h); }
.nl-waterfall .wf-track { position:absolute; inset:0; background:#eef2f7; border-radius:8px; overflow:hidden; }
.nl-waterfall .wf-step { position:absolute; top:0; bottom:0; border-radius:8px; display:flex; align-items:center; justify-content:space-between; padding:0 8px; font-weight:700; color:#fff; font-size:12px; }
.nl-waterfall .wf-step.baseline { background:#64748b; justify-content:center; }
.nl-waterfall .wf-step.controllable { background:#d93f0b; }  /* red */
.nl-waterfall .wf-step.structural  { background:#f59e0b; }  /* amber */
.nl-waterfall .wf-step.protective  { background:#10b981; } /* green */
.nl-waterfall .wf-step.residual    { background:#9CA3AF; } /* neutral gray */
.nl-waterfall .pp { z-index:1; }
.nl-waterfall .lift { font-weight:600; font-size:11px; opacity:.95; background:rgba(255,255,255,.18); padding:2px 6px; border-radius:999px; }
.nl-waterfall .wf-badge { flex:0 0 80px; text-align:right; font-weight:700; color:#0f172a; }
.nl-waterfall .wf-total { display:flex; justify-content:space-between; align-items:center; margin-top:14px; border-top:1px solid #e5e7eb; padding-top:12px; }
.nl-waterfall .wf-total .val { font-weight:800; font-size:20px; color:#d93f0b; }
.nl-waterfall .legend { color:#64748b; font-size:12px; }
.nl-tooltip { position:absolute; z-index:10; max-width:340px; background:#fff; color:#0f172a; border:1px solid #e5e7eb; border-radius:8px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,0.12); font-size:12px; display:none; }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="brand-section">
        <div class="brand-name">
          <span class="company-name">NORTHLIGHT</span>
          <span class="beta-label">beta</span>
        </div>
        <p class="tagline">Turn data into daylight</p>
        <div id="dataFreshness" class="data-freshness" style="display: none;">
          <span class="freshness-label">Data as of:</span>
          <span class="freshness-date">â€”</span>
        </div>
      </div>
      <nav class="nav-tabs">
        <a href="/" class="nav-tab">Benchmark MVP</a>
        <a href="/book" class="nav-tab active">Account Priority</a>
      </nav>
    </div>
  </header>

  <main>
    <div style="margin-bottom: var(--space-8);">
      <h1 style="font-size:36px;">Account Priority Queue</h1>
      <p class="subtext">Accounts are scored and prioritized based on retention risk and business value.</p>
    </div>

    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-number" id="totalAccounts">â€”</div>
        <div class="summary-label">Scored Accounts</div>
      </div>
      <div class="summary-card critical">
        <div class="summary-number critical" id="p1Critical">â€”</div>
        <div class="summary-label">P1 Critical</div>
      </div>
      <div class="summary-card high">
        <div class="summary-number high" id="p2High">â€”</div>
        <div class="summary-label">P2 High Priority</div>
      </div>
      <div class="summary-card">
        <div class="summary-number" id="budgetAtRisk">â€”</div>
        <div class="summary-label">Total Monthly Budget</div>
      </div>
    </div>

    <div class="filter-bar">
      <div class="filter-group">
        <div class="filter-label">View</div>
        <select id="viewFilter" class="filter-select">
          <option value="optimizer">Optimizer View</option>
        </select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Optimizer</div>
        <select id="optimizerFilter" class="filter-select"><option value="">All Optimizers</option></select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Account Manager</div>
        <select id="amFilter" class="filter-select"><option value="">All AMs</option></select>
      </div>
      <div class="filter-group">
        <div class="filter-label">Partner</div>
        <select id="partnerFilter" class="filter-select"><option value="">All Partners</option></select>
      </div>
      <div class="filter-group" id="advertiserFilterGroup" style="display: none;">
        <div class="filter-label">Advertiser</div>
        <select id="advertiserFilter" class="filter-select"><option value="">All Advertisers</option></select>
      </div>
      <div class="filter-group">
        <div class="filter-label">GM</div>
        <select id="gmFilter" class="filter-select"><option value="">All GMs</option></select>
      </div>
    </div>

    <div class="content-card">
      <div id="cardsContainer" class="cards-list">
        <div style="text-align:center; padding:48px;">Loading accounts...</div>
      </div>
      <button id="loadMoreBtn" class="load-more">Load more</button>
    </div>
  </main>

  <script>
document.addEventListener('DOMContentLoaded', () => {
  // ===== API bases =====
  const API_BASES = [
    window.location.origin,     // Current page origin (localhost:8000)
    'http://localhost:8000',    // Explicit local development server
    'https://northlight-wsgw.onrender.com',
    'https://northlight-api-dev.onrender.com',
  ];

  // ===== DOM refs =====
  const el = {
    totalAccounts: document.getElementById('totalAccounts'),
    p1Critical:    document.getElementById('p1Critical'),
    p2High:        document.getElementById('p2High'),
    budgetAtRisk:  document.getElementById('budgetAtRisk'),

    viewFilter:      document.getElementById('viewFilter'),
    optimizerFilter: document.getElementById('optimizerFilter'),
    partnerFilter:   document.getElementById('partnerFilter'),
    advertiserFilter: document.getElementById('advertiserFilter'),
    advertiserFilterGroup: document.getElementById('advertiserFilterGroup'),
    amFilter:        document.getElementById('amFilter'),
    gmFilter:        document.getElementById('gmFilter'),

    cardsContainer:  document.getElementById('cardsContainer'),
    loadMoreBtn:     document.getElementById('loadMoreBtn'),

    dataFreshness:   document.getElementById('dataFreshness'),
    freshnessDate:   document.querySelector('.freshness-date'),
  };

  // ===== State =====
  const state = { accounts: [], pageSize: 50, rendered: 0 };

  // ===== Number & string helpers =====
  const toNum = (v) => {
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  };
  const pctInt = (v) => {
    const n = toNum(v);
    return n == null ? null : Math.round(n * 100);
  };
  const fmtPct = (v) => v == null ? 'â€”' : `${v}%`;
  const fmtMoney0 = (x) => (x == null || isNaN(x)) ? 'â€”' : '$' + Math.round(Number(x)).toLocaleString('en-US');

  // ===== API =====
  async function fetchFromAny(path, params = {}) {
    const qs = new URLSearchParams(params).toString();
    for (const base of API_BASES) {
      try {
        const url = `${base}${path}?${qs}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`${res.status}`);
        return await res.json();
      } catch (e) { /* try next base */ }
    }
    throw new Error('All API bases failed');
  }

  // ===== Data Freshness =====
  async function fetchDataFreshness() {
    try {
      const metadata = await fetchFromAny('/api/v1/book/metadata');
      displayDataFreshness(metadata);
    } catch (e) {
      console.warn('Could not fetch data freshness:', e);
      // Silently fail - don't show indicator if we can't get the data
    }
  }

  function displayDataFreshness(metadata) {
    if (!metadata || metadata.error) {
      return; // Don't show anything if there's an error
    }

    const { data_snapshot_date, last_modified_display, record_count, file_name } = metadata;

    if (data_snapshot_date) {
      // Format date nicely (e.g., "Sept 16, 2025")
      const date = new Date(data_snapshot_date + 'T00:00:00');
      const formatted = date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      el.freshnessDate.textContent = formatted;

      // Add tooltip with more details
      const tooltip = `File: ${file_name}\nLast Modified: ${last_modified_display}\nRecords: ${record_count?.toLocaleString() || 'Unknown'}`;
      el.dataFreshness.title = tooltip;

      // Show the indicator
      el.dataFreshness.style.display = 'block';
    }
  }
  async function fetchData(params = {}) {
    const [summary, accountsResponse] = await Promise.all([
      fetchFromAny('/api/v1/book/summary', params),
      fetchFromAny('/api/v1/book/accounts', params),
    ]);

    // Extract accounts array from response object
    const accounts = accountsResponse?.accounts || accountsResponse || [];

    if (Array.isArray(accounts) && accounts.length) {
      console.log('Sample record:', accounts[0]);
    }
    return { summary, accounts };
  }

  // ===== Filters =====
  function populateFilters(facets) {
    const set = (select, options, label) => {
      const cur = select.value;
      select.innerHTML = `<option value="">All ${label}</option>`;
      (options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = opt; o.textContent = opt; select.appendChild(o);
      });
      select.value = cur;
    };
    set(el.optimizerFilter, facets?.optimizers, 'Optimizers');
    set(el.partnerFilter,   facets?.partners,   'Partners');
    set(el.amFilter,        facets?.ams,        'AMs');
    set(el.gmFilter,        facets?.gms,        'GMs');
  }
  function cleanVal(sel){
    const v = sel?.value?.trim();
    return (v && v.toLowerCase()!=='undefined' && v.toLowerCase()!=='null') ? v : null;
  }

  // ===== Summary =====
  function renderSummary(summary) {
    const c = summary?.counts || {};
    el.totalAccounts.textContent = c.total_accounts ?? '0';
    el.p1Critical.textContent    = c.p1_critical ?? '0';
    el.p2High.textContent        = c.p2_high ?? '0';
    el.budgetAtRisk.textContent  = fmtMoney0(summary?.budget_at_risk ?? 0);
  }

  function updateTotalBudgetFromAccounts(accounts){
    const total = (accounts || []).reduce((s, a) => s + (Number(a?.campaign_budget) || 0), 0);
    el.budgetAtRisk.textContent = fmtMoney0(total);
  }

  // ===== Driver parsing =====
  function parseDrivers(raw) {
    if (!raw) return null;
    if (typeof raw === 'object') return raw;
    if (typeof raw === 'string') {
      try { return JSON.parse(raw); } catch {}
      try { return JSON.parse(JSON.parse(raw)); } catch {}
      return null;
    }
    return null;
  }

  // ===== NEW: Centralized Status Logic =====
  function getAccountStatus(acc) {
      if (acc.is_safe === true) return 'safe';
      const p = toNum(acc.churn_prob_90d);
      if (p == null) return 'monitoring';
      if (p >= 0.40) return 'critical';
      if (p >= 0.20) return 'warning';
      return 'monitoring';
  }

  function primaryIssue(acc, status){
    if (status === 'safe') {
        return { text: acc.headline_diagnosis || 'Performing Well', sev: 'safe' };
    }
    const text = acc.headline_diagnosis || acc.primary_issue || 'Monitoring';
    const sev = status === 'critical' ? 'critical' : (status === 'warning' ? 'warning' : 'neutral');
    return { text, sev };
  }
  
  const teamLine = (acc) => [acc.optimizer, acc.am, acc.gm].filter(Boolean).join(' / ') || 'â€”';

  // ===== Age rendering with new runtime fields =====
  function renderAge(acc) {
    const tdays = toNum(acc.true_days_running);
    const clabel = acc.cycle_label;

    if (Number.isFinite(tdays) && tdays > 0) {
      const ageText = `${Math.round(tdays)} days`;
      const labelText = clabel ? ` (${clabel})` : '';
      return { main: ageText, detail: labelText };
    }
    // Fallback to old behavior so nothing breaks
    const io = toNum(acc.io_cycle);
    if (Number.isFinite(io) && io >= 0) {
      return { main: `${io} months`, detail: '' };
    }
    return { main: 'â€”', detail: '' };
  }

  // ===== Actions from drivers =====
  function buildActionsFromDrivers(drivers) {
    const items = [];
    if (!drivers) return items;
    const impacts = Object.fromEntries((drivers.drivers || []).map(d => [d.name, d.impact || 0]));
    const add = (title, impact, cta) => items.push({ title, impact, cta });

    if ('Single Product' in impacts) add('Add a second product (e.g., SEO or Website)', impacts['Single Product'], 'Start Proposal â†’');
    if ('Zero Leads (30d)' in impacts) add('Fix tracking & lead quality audit', impacts['Zero Leads (30d)'], 'Open Checklist â†’');
    if (Object.keys(impacts).some(k => k.startsWith('High CPL') || k.startsWith('Elevated CPL') || k.startsWith('CPL above goal'))) {
      const k = Object.keys(impacts).find(k => k.includes('CPL'));
      add('Budget/keyword optimization for lead volume', impacts[k], 'Open Planner â†’');
    }
    if ('Early Account (â‰¤90d)' in impacts) {
      add('Set expectations / launch plan call', impacts['Early Account (â‰¤90d)'], 'Schedule Call â†’');
    }
    return items.sort((a,b)=>b.impact-a.impact).slice(0,3);
  }

  // ===== Expanded sections =====
  let NL_RISK_VIEW = 'attribution';
  
  function renderRiskAttribution(acc){
    // Simplified - only show waterfall mount point, no legacy breakdown
    return `
      <div class="section-title">Churn Risk Breakdown</div>
      <section class="card-section" id="risk-breakdown">
        <div id="churn-waterfall"></div>
      </section>`;
  }

  function goalRealismSection(acc){
    const adv = acc.goal_advice_json || null;
    if (!adv || adv.show !== true) return '';

    const s = String(adv.status || '');
    const badgeMap = {
      missing: 'Missing goal',
      too_low: 'Goal too low',
      too_high: 'Unrealistic (too high)',
      wildly_high: 'Wildly high'
    };
    const badge = badgeMap[s] || 'Goal check';

    const rec = adv.recommended || {};
    const rPt = rec.point != null ? Math.round(rec.point) : null;
    const rLo = rec.range && rec.range[0] != null ? Math.round(rec.range[0]) : null;
    const rHi = rec.range && rec.range[1] != null ? Math.round(rec.range[1]) : null;

    const perf = adv.performance_band || {};
    const vsRec = perf.vs_recommended || 'â€”';
    const vsGoal = perf.vs_goal || 'â€”';

    const bn = adv.benchmark || {};
    const p50 = bn.p50 != null ? Math.round(bn.p50) : null;

    // Goal information
    const originalGoal = adv.goal_advertiser != null ? Math.round(adv.goal_advertiser) : null;
    const effectiveGoal = adv.goal_effective != null ? Math.round(adv.goal_effective) : null;
    const wasSubstituted = adv.goal_was_substituted || false;

    // Goal display logic
    let goalDisplay = '';
    if (wasSubstituted && originalGoal != null && effectiveGoal != null) {
      goalDisplay = `
        <div class="metric-item">
          <span class="metric-label">Original goal:</span>
          <span class="metric-value" style="color: #d73502;">$${originalGoal.toLocaleString('en-US')}</span>
          <span class="metric-context">(${s === 'missing' ? 'was missing' : 'too low'})</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">System goal:</span>
          <span class="metric-value" style="color: #28a745;">$${effectiveGoal.toLocaleString('en-US')}</span>
          <span class="metric-context">ðŸ¤– Auto-adjusted to benchmark</span>
        </div>`;
    } else if (originalGoal != null) {
      goalDisplay = `
        <div class="metric-item">
          <span class="metric-label">Current goal:</span>
          <span class="metric-value">$${originalGoal.toLocaleString('en-US')}</span>
        </div>`;
    }

    return `
      <div class="section-title">Goal Realism</div>
      <div class="metrics-bar">
        <div class="metric-item">
          <span class="status-badge warning">${badge}</span>
        </div>
        ${goalDisplay}
        <div class="metric-item">
          <span class="metric-label">Recommended goal:</span>
          <span class="metric-value">${rPt != null ? '$' + rPt.toLocaleString('en-US') : 'â€”'}</span>
          <span class="metric-context">${(rLo!=null && rHi!=null) ? `(Range: $${rLo.toLocaleString('en-US')}â€“$${rHi.toLocaleString('en-US')})` : ''}</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Benchmark p50:</span>
          <span class="metric-value">${p50 != null ? '$' + p50.toLocaleString('en-US') : 'â€”'}</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Performance vs recommended:</span>
          <span class="metric-value">${vsRec}</span>
        </div>
        <div class="metric-item">
          <span class="metric-label">Vs current goal:</span>
          <span class="metric-value">${vsGoal}</span>
        </div>
        <div class="metric-item">
          <span class="metric-context">${adv.rationale || ''}</span>
        </div>
      </div>
    `;
  }
  
  function expandedMetrics(acc){
    const cpl   = toNum(acc.running_cid_cpl);
    const goal  = toNum(acc.effective_cpl_goal ?? acc.cpl_goal ?? acc.bsc_cpl_avg);
    const util  = toNum(acc.utilization);
    const spent = toNum(acc.amount_spent);
    const budg  = toNum(acc.campaign_budget);
    const io    = toNum(acc.io_cycle);
    const leads = toNum(acc.running_cid_leads) ?? 0;
    const expTdPlan  = toNum(acc.expected_leads_to_date);

    // Check if goal was substituted for CPL display
    const adv = acc.goal_advice_json || {};
    const wasSubstituted = adv.goal_was_substituted || false;
    const originalGoal = toNum(acc.cpl_goal);
    const effectiveGoal = toNum(acc.effective_cpl_goal);

    // Goal display for CPL metric - always show original goal primarily
    let goalContext = '';
    if (originalGoal != null) {
      if (wasSubstituted && effectiveGoal != null) {
        goalContext = `(Goal: ${fmtMoney0(originalGoal)}, Operating: ${fmtMoney0(effectiveGoal)} ðŸ¤–)`;
      } else {
        goalContext = `(Goal: ${fmtMoney0(originalGoal)})`;
      }
    } else {
      goalContext = '(Goal: â€”)';
    }

    const cplDeltaPct = (cpl!=null && originalGoal > 0) ? Math.round(((cpl/originalGoal)-1)*100) : null;

    // Calculate lead-based pacing using expected_leads_to_date
    const leadPacingPct = (leads != null && expTdPlan != null && expTdPlan > 0)
      ? Math.round(((leads / expTdPlan) - 1) * 100)
      : null;

    const trend = (d, upIsBad = true) => {
        if (d==null) return {txt:'â†’',cls:'trend-neutral'};
        const up = upIsBad ? 'trend-up' : 'trend-down';
        const down = upIsBad ? 'trend-down' : 'trend-up';
        return d > 0 ? {txt:`â†‘${d}%`, cls: up} : d < 0 ? {txt:`â†“${Math.abs(d)}%`, cls: down} : {txt:'â†’', cls:'trend-neutral'};
    }
    const tCpl = trend(cplDeltaPct);

    // Use lead-based pacing if available, otherwise fall back to utilization
    const pacingValue = leadPacingPct != null ? leadPacingPct : util;
    const pacingText = (pacingValue==null) ? 'â€”' : (pacingValue < -25 ? 'Behind' : (pacingValue > 25 ? 'Ahead' : 'On track'));

    return `
      <div class="section-title">Key Metrics</div>
      <div class="metrics-bar">
        <div class="metric-item"><span class="metric-label">CPL:</span><span class="metric-value">${cpl!=null?fmtMoney0(cpl):'â€”'}</span><span class="metric-trend ${tCpl.cls}">${tCpl.txt}</span><span class="metric-context">${goalContext}</span></div>
        <div class="metric-item"><span class="metric-label">Leads:</span><span class="metric-value">${leads}</span><span class="metric-context">(Expected: ${expTdPlan!=null?Math.round(expTdPlan):'â€”'})</span></div>
        <div class="metric-item"><span class="metric-label">Pacing:</span><span class="metric-value">${pacingValue!=null? pacingValue+'%':'â€”'}</span><span class="metric-context">${pacingText}</span></div>
        <div class="metric-item"><span class="metric-label">Spent:</span><span class="metric-value">${fmtMoney0(spent)}</span><span class="metric-context">/ ${fmtMoney0(budg)}</span></div>
        <div class="metric-item"><span class="metric-label">Account Age:</span><span class="metric-value">${renderAge(acc).main}</span><span class="metric-context" style="color:var(--gray-500);">${renderAge(acc).detail}</span></div>
      </div>`;
  }

  function expandedActions(acc){
    const p = toNum(acc.churn_prob_90d);
    const drivers = parseDrivers(acc.risk_drivers_json);
    const items = buildActionsFromDrivers(drivers);
    if (p == null || !items.length) {
      return `<div class="section-title">Priority Actions</div><div class="metrics-bar"><div style="color:var(--gray-500);font-size:13px;">No recommended actions available.</div></div>`;
    }
    const total = pctInt(p);
    const rows = items.map(it => {
      const reduce = it.impact|0;
      const after  = total!=null ? Math.max(0, total - reduce) : null;
      return `<div class="action-item"><div class="action-content"><div class="action-title">${it.title}</div><div class="action-impact">${after!=null?`Reduces churn to ${after}% (âˆ’${reduce}pp)`:`Estimated reduction âˆ’${reduce}pp`}</div></div><button class="action-button">${it.cta}</button></div>`;
    }).join('');
    return `<div class="section-title">Priority Actions</div><div class="priority-actions">${rows}</div>`;
  }

  function expandedSafeContent(acc) {
      return `
        ${expandedMetrics(acc)}
        <div class="section-title">Optimization Opportunities</div>
        <div class="priority-actions">
            <div class="action-item"><div class="action-content"><div class="action-title">Review Performance & Plan Next Steps</div><div class="action-impact">Discuss budget, new channels, or creative updates.</div></div><button class="action-button">Schedule Call â†’</button></div>
            <div class="action-item"><div class="action-content"><div class="action-title">Explore Budget Increase</div><div class="action-impact">Capitalize on strong performance to scale results.</div></div><button class="action-button">Open Planner â†’</button></div>
        </div>
      `;
  }

  // ===== NEW: Helper for positive pills on Safe accounts =====
  function getPositivePills(acc) {
      const pills = [{ text: 'Performing', type: 'success' }];

      // Use lead-based pacing for "Good Pacing" pill
      const leads = toNum(acc.running_cid_leads) ?? 0;
      const expTdPlan = toNum(acc.expected_leads_to_date);
      const leadPacingPct = (leads != null && expTdPlan != null && expTdPlan > 0)
        ? ((leads / expTdPlan) - 1) * 100
        : null;

      // Good pacing if within Â±25% of expected leads, otherwise fall back to utilization
      if (leadPacingPct != null) {
          if (leadPacingPct >= -25 && leadPacingPct <= 25) {
              pills.push({ text: 'Good Pacing', type: 'info' });
          }
      } else {
          // Fallback to utilization if expected leads not available
          const util = toNum(acc.utilization);
          if (util >= 0.9 && util <= 1.15) {
              pills.push({ text: 'Good Pacing', type: 'info' });
          }
      }
      const cpl = toNum(acc.running_cid_cpl);
      const goal = toNum(acc.effective_cpl_goal ?? acc.cpl_goal);
      if (cpl != null && goal != null && cpl < goal) {
          pills.push({ text: 'CPL Below Goal', type: 'info' });
      }
      const leads = toNum(acc.running_cid_leads) ?? 0;
      const expTdPlan = toNum(acc.expected_leads_to_date);
      if (leads > 0 && expTdPlan != null && leads >= expTdPlan) {
          pills.push({ text: 'Strong Lead Volume', type: 'info' });
      }
      return pills.slice(0, 4); // Max 4 pills
  }

  // ===== Card builder (REFACTORED) =====
  function cardHeader(acc){
    const toKey = (s) => (s ?? '').toString().trim().toLowerCase();
    
    // --- Determine Account Status ---
    const status = getAccountStatus(acc);

    // --- Advertiser & Campaign Names ---
    const partnerRaw   = acc.partner_name || '';
    const advRaw       = acc.advertiser_name || acc.business_name || acc.account_name || '';
    const campaign     = acc.campaign_name || acc.bid_name || '';
    let advertiser = advRaw || campaign || 'Unknown Advertiser';
    if (toKey(advertiser) === toKey(partnerRaw) && campaign) {
      advertiser = campaign;
    }
    const showPartner = partnerRaw && toKey(partnerRaw) !== toKey(advertiser);

    // --- Core Data Points ---
    const budget = toNum(acc.campaign_budget);
    const p = toNum(acc.churn_prob_90d);
    const flare = toNum(acc.flare_score);
    const issue = primaryIssue(acc, status);
    
    // --- Status-Dependent Displays ---
    const flareDisplay = status === 'safe'
        ? { value: 'âœ“', label: 'SAFE', class: 'safe' }
        : { value: flare != null ? Math.round(flare) : 'â€”', label: 'FLARE', class: status };

    const pills = status === 'safe'
        ? getPositivePills(acc)
        : (Array.isArray(acc.diagnosis_pills) ? acc.diagnosis_pills.slice(0,3) : []);

    const pillSpan = (pill) => {
        const map = {critical:'urgent', warning:'warning', success:'success', info:'info', neutral:'info'};
        return `<span class="status-badge ${map[pill.type]||'info'}">${pill.text}</span>`;
    };

    return `
      <div class="priority-card ${status}">
        <div class="card-header" role="button" tabindex="0" aria-expanded="false">
          <div class="card-main-row">
            <div class="churn-display">
              <div class="churn-percentage ${flareDisplay.class}">${flareDisplay.value}</div>
              <div class="churn-label">${flareDisplay.label}</div>
              ${status !== 'safe' ? `<div class="subtext" style="margin-top:4px;">Churn: ${fmtPct(pctInt(p))}</div>` : ''}
            </div>

            <div class="account-section">
              <div class="account-name">${advertiser}</div>
              ${campaign && toKey(campaign) !== toKey(advertiser) ? `<div class="campaign-name-sub">${campaign}</div>` : ''}
              <div class="primary-issue ${issue.sev}">${issue.text}</div>
              <div class="account-details">
                <div class="detail-item"><span>CID:</span><strong>${acc.campaign_id || 'N/A'}</strong></div>
                <div class="detail-item"><span>Team:</span><strong>${teamLine(acc)}</strong></div>
                ${showPartner ? `<div class="detail-item"><span>Partner:</span><strong>${partnerRaw}</strong></div>` : ''}
                <div class="detail-item"><span>Age:</span><strong>${renderAge(acc).main}</strong><span style="color:var(--gray-500);font-size:11px;">${renderAge(acc).detail}</span></div>
              </div>
            </div>
            
            <div class="rar-section">
              <div class="rar-amount">${budget != null ? fmtMoney0(budget) : 'â€”'}</div>
              <div class="rar-label">Monthly Budget</div>
            </div>
          </div>

          <div class="status-line">
            ${pills.map(pillSpan).join('')}
            <span class="time-indicator">Days active: ${acc.days_active ?? 'â€”'}</span>
          </div>

          <span class="expand-arrow">â–¸</span>
        </div>

        <div class="card-expanded">
          <div class="expanded-content">
            ${status === 'safe'
                ? expandedSafeContent(acc)
                : `${renderRiskAttribution(acc)}${expandedMetrics(acc)}${goalRealismSection(acc)}${expandedActions(acc)}`
            }
          </div>
        </div>
      </div>`;
  }


  // ===== Card interactions =====
  function attachCardToggles(cards, accounts){
    cards.forEach((card, i)=>{
      const acc = accounts[i];
      const header = card.querySelector('.card-header');
      const expanded = card.querySelector('.card-expanded');
      const arrow = card.querySelector('.expand-arrow');

      const animateBars = () => {
        const bars = expanded.querySelectorAll('.factor-fill');
        bars.forEach((bar, i) => {
          const target = bar.style.width;
          if (!target || target === '0%') return;
          bar.style.width = '0%';
          setTimeout(()=>{ bar.style.width = target; }, 100 + i*50);
        });
      };
      const toggle = ()=>{
        const show = !expanded.classList.contains('show');
        expanded.classList.toggle('show', show);
        arrow.classList.toggle('expanded', show);
        header.setAttribute('aria-expanded', String(show));
        if (show) animateBars();
      };
      header.addEventListener('click', toggle);
      header.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); toggle(); }});
    });
  }

  // ===== Render cards (with paging) =====
  function renderCards(allAccounts, reset=true){
    const container = el.cardsContainer;
    const loadBtn = el.loadMoreBtn;

    if (reset){
      container.innerHTML = '';
      state.rendered = 0;
    }

    if (!Array.isArray(allAccounts) || allAccounts.length===0){
      container.innerHTML = `<div style="text-align:center;padding:48px;color:var(--gray-500)">No accounts match the selected filters.</div>`;
      loadBtn.style.display = 'none';
      return;
    }
    
    const sorted = reset ? allAccounts.slice() : allAccounts;
    const oldRenderedCount = state.rendered;

    const slice = sorted.slice(state.rendered, state.rendered + state.pageSize);
    const html = slice.map(cardHeader).join('');
    container.insertAdjacentHTML('beforeend', html);

    const newCards = Array.from(container.children).slice(oldRenderedCount);
    attachCardToggles(newCards, slice);

    state.rendered += slice.length;
    loadBtn.style.display = (state.rendered < sorted.length) ? 'inline-flex' : 'none';
    loadBtn.onclick = ()=> renderCards(sorted, /*reset*/false);
    
    // Notify external scripts about data update
    window.dispatchEvent(new CustomEvent('accountsDataUpdated', { 
      detail: { accounts: allAccounts, slice: slice } 
    }));
  }

  // ===== Filtering =====
  async function handleFilterChange(){
    const params = {};
    const raw = {
      view: el.viewFilter.value,
      optimizer: cleanVal(el.optimizerFilter),
      partner:   cleanVal(el.partnerFilter),
      advertiser: cleanVal(el.advertiserFilter),
      am:        cleanVal(el.amFilter),
      gm:        cleanVal(el.gmFilter),
    };
    Object.entries(raw).forEach(([k,v])=>{ if(v!=null) params[k]=v; });

    el.cardsContainer.innerHTML = `<div style="text-align:center; padding:48px;">Loading...</div>`;
    el.loadMoreBtn.style.display = 'none';

    try{
      const { summary, accounts } = await fetchData(params);
      renderSummary(summary);
      state.accounts = accounts || [];
      updateTotalBudgetFromAccounts(state.accounts);
      renderCards(state.accounts, true);
    }catch(err){
      console.error('Filter fetch failed:', err);
      el.cardsContainer.innerHTML = `<div style="text-align:center; padding:48px; color: var(--red-600);">Error loading data. Could not connect to API.</div>`;
    }
  }

  // ===== Partner-dependent advertiser loading =====
  async function handlePartnerChange() {
    const partner = cleanVal(el.partnerFilter);

    if (partner) {
      // Load advertisers for selected partner
      try {
        const advertisers = await fetchFromAny(`/api/v1/book/partners/${encodeURIComponent(partner)}/advertisers`);

        // Populate dropdown
        el.advertiserFilter.innerHTML = '<option value="">All Advertisers</option>';
        advertisers.forEach(adv => {
          const option = document.createElement('option');
          option.value = adv.name;
          option.textContent = `${adv.name} (${fmtMoney0(adv.total_budget)})`;
          el.advertiserFilter.appendChild(option);
        });

        el.advertiserFilterGroup.style.display = 'flex';
      } catch (e) {
        console.error('Failed to load advertisers:', e);
        el.advertiserFilterGroup.style.display = 'none';
      }
    } else {
      // Hide advertiser dropdown when no partner selected
      el.advertiserFilterGroup.style.display = 'none';
      el.advertiserFilter.value = '';
    }

    // Trigger filter refresh
    handleFilterChange();
  }

  // ===== Init =====
  async function init(){
    try{
      // Fetch data freshness info first (non-blocking)
      fetchDataFreshness();

      const { summary, accounts } = await fetchData({ view: el.viewFilter.value });
      renderSummary(summary);
      populateFilters(summary.facets || {});
      state.accounts = accounts || [];
      updateTotalBudgetFromAccounts(state.accounts);
      renderCards(state.accounts, true);
      [el.viewFilter, el.optimizerFilter, el.partnerFilter, el.advertiserFilter, el.amFilter, el.gmFilter]
        .forEach(dd => dd && dd.addEventListener('change', handleFilterChange));

      // Special handler for partner filter to load advertisers
      el.partnerFilter.addEventListener('change', handlePartnerChange);
    }catch(err){
      console.error('Init failed:', err);
      el.cardsContainer.innerHTML = `<div style="text-align:center; padding:48px; color: var(--red-600);">Error loading data. Could not connect to API.</div>`;
    }
  }

  init();
});
  </script>
  <script type="module" src="/frontend/book/script.js"></script>
</body>
</html>
